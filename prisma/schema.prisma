generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String?
  image              String?
  emailVerified      DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accounts           Account[]
  activityLogs       ActivityLog[]
  apiLogs            ApiLog[]
  errorLogs          ErrorLog[]
  attachments        Attachment[]
  attendanceCheckIns AttendanceCheckIn[]
  emailsReceived     EmailLog[]
  eventRSVPs         EventRSVP[]
  memberships        Membership[]
  reactions          Reaction[]
  sessions           Session[]
  teamsCreated       Team[]              @relation("TeamCreator")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Team {
  id                        String            @id @default(cuid())
  name                      String
  division                  Division
  createdById               String
  adminInviteCodeHash       String
  memberInviteCodeHash      String
  adminInviteCodeEncrypted  String
  memberInviteCodeEncrypted String
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  announcements             Announcement[]
  calendarEvents            CalendarEvent[]
  eventBudgets              EventBudget[]
  expenses                  Expense[]
  memberships               Membership[]
  purchaseRequests          PurchaseRequest[]
  subteams                  Subteam[]
  createdBy                 User              @relation("TeamCreator", fields: [createdById], references: [id])
  tests                     Test[]

  @@index([createdById])
}

model Membership {
  id                  String              @id @default(cuid())
  userId              String
  teamId              String
  role                Role
  subteamId           String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  roles               String[]            @default([])
  announcements       Announcement[]
  announcementReplies AnnouncementReply[] @relation("AnnouncementReplies")
  attendanceCheckIns  AttendanceCheckIn[]
  attendeeEvents      CalendarEvent[]     @relation("AttendeeEvents")
  calendarEvents      CalendarEvent[]     @relation("CreatorEvents")
  subteam             Subteam?            @relation(fields: [subteamId], references: [id])
  team                Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  rosterAssignments   RosterAssignment[]

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([subteamId])
}

model Subteam {
  id                       String                   @id @default(cuid())
  teamId                   String
  name                     String
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  announcementVisibilities AnnouncementVisibility[]
  calendarEvents           CalendarEvent[]
  eventBudgets             EventBudget[]
  expenses                 Expense[]
  members                  Membership[]
  purchaseRequests         PurchaseRequest[]
  rosterAssignments        RosterAssignment[]
  team                     Team                     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  testAssignments          TestAssignment[]

  @@index([teamId])
}

model Event {
  id                  String               @id @default(cuid())
  division            Division
  name                String
  slug                String
  maxCompetitors      Int                  @default(2)
  selfScheduled       Boolean              @default(false)
  createdAt           DateTime             @default(now())
  conflictGroupEvents ConflictGroupEvent[]
  eventBudgets        EventBudget[]
  expenses            Expense[]
  purchaseRequests    PurchaseRequest[]
  rosterAssignments   RosterAssignment[]

  @@unique([division, slug])
  @@index([division])
}

model ConflictGroup {
  id          String               @id @default(cuid())
  division    Division
  blockNumber Int
  name        String
  createdAt   DateTime             @default(now())
  events      ConflictGroupEvent[]

  @@unique([division, blockNumber])
  @@index([division])
}

model ConflictGroupEvent {
  id              String        @id @default(cuid())
  conflictGroupId String
  eventId         String
  createdAt       DateTime      @default(now())
  conflictGroup   ConflictGroup @relation(fields: [conflictGroupId], references: [id], onDelete: Cascade)
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([conflictGroupId, eventId])
  @@index([eventId])
}

model RosterAssignment {
  id           String     @id @default(cuid())
  subteamId    String
  membershipId String
  eventId      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  event        Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  subteam      Subteam    @relation(fields: [subteamId], references: [id], onDelete: Cascade)

  @@unique([membershipId, eventId])
  @@index([subteamId, eventId])
  @@index([eventId])
}

model Announcement {
  id              String                   @id @default(cuid())
  teamId          String
  authorId        String
  title           String
  content         String
  calendarEventId String?                  @unique
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  important       Boolean                  @default(false)
  author          Membership               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  calendarEvent   CalendarEvent?           @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
  team            Team                     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  replies         AnnouncementReply[]
  visibilities    AnnouncementVisibility[]
  attachments     Attachment[]
  emails          EmailLog[]
  reactions       Reaction[]

  @@index([teamId])
  @@index([authorId])
  @@index([createdAt])
  @@index([calendarEventId])
}

model AnnouncementReply {
  id             String       @id @default(cuid())
  announcementId String
  authorId       String
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  author         Membership   @relation("AnnouncementReplies", fields: [authorId], references: [id], onDelete: Cascade)
  reactions      Reaction[]

  @@index([announcementId])
  @@index([authorId])
  @@index([createdAt])
}

model Reaction {
  id             String             @id @default(cuid())
  emoji          String
  userId         String
  createdAt      DateTime           @default(now())
  announcementId String?
  eventId        String?
  replyId        String?
  announcement   Announcement?      @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  calendarEvent  CalendarEvent?     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  reply          AnnouncementReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, announcementId, emoji], name: "userId_announcementId_emoji")
  @@unique([userId, eventId, emoji], name: "userId_eventId_emoji")
  @@unique([userId, replyId, emoji], name: "userId_replyId_emoji")
  @@index([announcementId])
  @@index([eventId])
  @@index([replyId])
  @@index([userId])
}

model AnnouncementVisibility {
  id             String            @id @default(cuid())
  announcementId String
  scope          AnnouncementScope
  subteamId      String?
  createdAt      DateTime          @default(now())
  announcement   Announcement      @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  subteam        Subteam?          @relation(fields: [subteamId], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([subteamId])
}

model CalendarEvent {
  id           String        @id @default(cuid())
  teamId       String
  creatorId    String
  scope        CalendarScope
  title        String
  description  String?
  startUTC     DateTime
  endUTC       DateTime
  location     String?
  color        String?
  subteamId    String?
  attendeeId   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  rsvpEnabled  Boolean       @default(true)
  important    Boolean       @default(false)
  announcement Announcement?
  attachments  Attachment[]
  attendance   Attendance?
  attendee     Membership?   @relation("AttendeeEvents", fields: [attendeeId], references: [id], onDelete: Cascade)
  creator      Membership    @relation("CreatorEvents", fields: [creatorId], references: [id], onDelete: Cascade)
  subteam      Subteam?      @relation(fields: [subteamId], references: [id], onDelete: Cascade)
  team         Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  rsvps        EventRSVP[]
  reactions    Reaction[]

  @@index([teamId])
  @@index([creatorId])
  @@index([subteamId])
  @@index([attendeeId])
  @@index([startUTC])
}

model EventRSVP {
  id        String        @id @default(cuid())
  eventId   String
  userId    String
  status    RSVPStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EmailLog {
  id                String        @id @default(cuid())
  announcementId    String?
  toUserId          String
  subject           String
  providerMessageId String?
  sentAt            DateTime      @default(now())
  announcement      Announcement? @relation(fields: [announcementId], references: [id])
  toUser            User          @relation(fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([toUserId])
}

model Attendance {
  id              String                  @id @default(cuid())
  calendarEventId String                  @unique
  teamId          String
  codeHash        String
  graceMinutes    Int                     @default(0)
  status          AttendanceStatus        @default(UPCOMING)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  calendarEvent   CalendarEvent           @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
  checkIns        AttendanceCheckIn[]
  codeAttempts    AttendanceCodeAttempt[]

  @@index([teamId])
  @@index([calendarEventId])
  @@index([status])
}

model AttendanceCheckIn {
  id           String        @id @default(cuid())
  attendanceId String
  userId       String
  membershipId String
  source       CheckInSource
  reason       String?
  checkedInAt  DateTime      @default(now())
  createdAt    DateTime      @default(now())
  attendance   Attendance    @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  membership   Membership    @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([attendanceId, userId])
  @@index([attendanceId])
  @@index([userId])
  @@index([membershipId])
}

model AttendanceCodeAttempt {
  id           String     @id @default(cuid())
  attendanceId String
  userId       String?
  ipAddress    String
  attemptedAt  DateTime   @default(now())
  success      Boolean
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId, userId, attemptedAt])
  @@index([attendanceId, ipAddress, attemptedAt])
}

model Attachment {
  id               String         @id @default(cuid())
  filename         String
  originalFilename String
  fileSize         Int
  mimeType         String
  filePath         String
  announcementId   String?
  calendarEventId  String?
  uploadedById     String
  createdAt        DateTime       @default(now())
  announcement     Announcement?  @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  calendarEvent    CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
  uploadedBy       User           @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([announcementId])
  @@index([calendarEventId])
  @@index([uploadedById])
}

model Expense {
  id                String           @id @default(cuid())
  teamId            String
  description       String
  category          String?
  amount            Float
  date              DateTime
  notes             String?
  purchaseRequestId String?          @unique
  addedById         String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  eventId           String?
  subteamId         String?
  event             Event?           @relation(fields: [eventId], references: [id])
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id])
  subteam           Subteam?         @relation(fields: [subteamId], references: [id])
  team              Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([eventId])
  @@index([subteamId])
  @@index([date])
  @@index([addedById])
}

model PurchaseRequest {
  id              String                @id @default(cuid())
  teamId          String
  requesterId     String
  description     String
  category        String?
  estimatedAmount Float
  justification   String?
  status          PurchaseRequestStatus @default(PENDING)
  reviewedById    String?
  reviewNote      String?
  reviewedAt      DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  adminOverride   Boolean               @default(false)
  eventId         String?
  subteamId       String?
  expense         Expense?
  event           Event?                @relation(fields: [eventId], references: [id])
  subteam         Subteam?              @relation(fields: [subteamId], references: [id])
  team            Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([eventId])
  @@index([subteamId])
  @@index([requesterId])
  @@index([status])
  @@index([createdAt])
}

model EventBudget {
  id        String   @id @default(cuid())
  teamId    String
  eventId   String
  maxBudget Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subteamId String?
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  subteam   Subteam? @relation(fields: [subteamId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, eventId, subteamId])
  @@index([teamId])
  @@index([eventId])
  @@index([subteamId])
}

model Test {
  id                     String            @id @default(cuid())
  teamId                 String
  name                   String
  description            String?
  instructions           String?
  status                 TestStatus        @default(DRAFT)
  durationMinutes        Int
  startAt                DateTime?
  endAt                  DateTime?
  allowLateUntil         DateTime?
  randomizeQuestionOrder Boolean           @default(false)
  randomizeOptionOrder   Boolean           @default(false)
  requireFullscreen      Boolean           @default(true)
  testPasswordHash       String?           // Password required to take the test (hashed)
  testPasswordPlaintext  String?           // Password in plaintext for admin viewing only
  releaseScoresAt        DateTime?
  maxAttempts            Int?              // Max attempts per user (null = unlimited)
  scoreReleaseMode       ScoreReleaseMode  @default(FULL_TEST) // What to release: score only, score + wrong questions, or full test
  createdByMembershipId  String
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  questions              Question[]
  team                   Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignments            TestAssignment[]
  attempts               TestAttempt[]
  audits                 TestAudit[]
  sections               TestSection[]

  @@index([teamId])
  @@index([status])
  @@index([createdByMembershipId])
}

model TestSection {
  id        String     @id @default(cuid())
  testId    String
  title     String?
  order     Int        @default(0)
  createdAt DateTime   @default(now())
  questions Question[]
  test      Test       @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
}

model Question {
  id               String           @id @default(cuid())
  testId           String
  sectionId        String?
  type             QuestionType
  promptMd         String
  explanation      String?
  points           Decimal          @db.Decimal(5, 2)
  order            Int              @default(0)
  shuffleOptions   Boolean          @default(false)
  numericTolerance Decimal?         @db.Decimal(8, 3)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  answers          AttemptAnswer[]
  section          TestSection?     @relation(fields: [sectionId], references: [id])
  test             Test             @relation(fields: [testId], references: [id], onDelete: Cascade)
  options          QuestionOption[]

  @@index([testId])
  @@index([sectionId])
}

model QuestionOption {
  id         String   @id @default(cuid())
  questionId String
  label      String
  isCorrect  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model TestAssignment {
  id                 String              @id @default(cuid())
  testId             String
  assignedScope      TestAssignmentScope
  subteamId          String?
  targetMembershipId String?
  createdAt          DateTime            @default(now())
  subteam            Subteam?            @relation(fields: [subteamId], references: [id], onDelete: Cascade)
  test               Test                @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([subteamId])
  @@index([targetMembershipId])
}

model TestAttempt {
  id                    String            @id @default(cuid())
  testId                String
  membershipId          String
  status                AttemptStatus     @default(NOT_STARTED)
  startedAt             DateTime?
  submittedAt           DateTime?
  gradeEarned           Decimal?          @db.Decimal(6, 2)
  proctoringScore       Int?
  clientFingerprintHash String?
  ipAtStart             String?
  ipAtSubmit            String?
  userAgentAtStart      String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  tabSwitchCount        Int               @default(0)
  timeOffPageSeconds    Int               @default(0)
  answers               AttemptAnswer[]
  gradeAdjustments      GradeAdjustment[]
  proctorEvents         ProctorEvent[]
  test                  Test              @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([membershipId])
  @@index([membershipId, testId])
  @@index([status])
}

model AttemptAnswer {
  id                String      @id @default(cuid())
  attemptId         String
  questionId        String
  answerText        String?
  selectedOptionIds Json?
  numericAnswer     Decimal?    @db.Decimal(16, 6)
  pointsAwarded     Decimal?    @db.Decimal(5, 2)
  gradedAt          DateTime?
  graderNote        String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  attempt           TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question          Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

model ProctorEvent {
  id        String           @id @default(cuid())
  attemptId String
  kind      ProctorEventKind
  ts        DateTime         @default(now())
  meta      Json?
  attempt   TestAttempt      @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([ts])
}

model GradeAdjustment {
  id                 String      @id @default(cuid())
  attemptId          String
  graderMembershipId String
  deltaPoints        Decimal     @db.Decimal(6, 2)
  reason             String
  createdAt          DateTime    @default(now())
  attempt            TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
}

model TestAudit {
  id                String          @id @default(cuid())
  testId            String
  actorMembershipId String
  action            TestAuditAction
  details           Json?
  createdAt         DateTime        @default(now())
  test              Test            @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([actorMembershipId])
  @@index([createdAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  action      String
  description String
  userId      String?
  metadata    Json?
  timestamp   DateTime @default(now())
  logType     LogType  @default(SYSTEM_EVENT)
  severity    SeverityLevel @default(INFO)
  route       String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@index([logType])
  @@index([severity])
  @@index([route])
}

model ApiLog {
  id           String   @id @default(cuid())
  method       String
  route        String
  statusCode   Int
  userId       String?
  executionTime Int     // in milliseconds
  ipAddress    String?
  userAgent    String?
  requestBody  Json?
  responseSize Int?     // in bytes
  error        String?
  timestamp    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([timestamp])
  @@index([route])
  @@index([method])
  @@index([statusCode])
  @@index([executionTime])
}

model ErrorLog {
  id          String   @id @default(cuid())
  errorType   String
  message     String
  stack       String?
  userId      String?
  route       String?
  severity    SeverityLevel @default(ERROR)
  metadata    Json?
  timestamp   DateTime @default(now())
  resolved    Boolean  @default(false)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([timestamp])
  @@index([severity])
  @@index([route])
  @@index([resolved])
}

enum Division {
  B
  C
}

enum Role {
  ADMIN
  MEMBER
}

enum AnnouncementScope {
  TEAM
  SUBTEAM
}

enum CalendarScope {
  PERSONAL
  SUBTEAM
  TEAM
}

enum RSVPStatus {
  YES
  NO
}

enum AttendanceStatus {
  UPCOMING
  ACTIVE
  ENDED
  CANCELLED
}

enum CheckInSource {
  CODE
  MANUAL
}

enum PurchaseRequestStatus {
  PENDING
  APPROVED
  DENIED
  COMPLETED
}

enum TestStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum QuestionType {
  MCQ_SINGLE
  MCQ_MULTI
  SHORT_TEXT
  LONG_TEXT
  NUMERIC
}

enum TestAssignmentScope {
  TEAM
  SUBTEAM
  PERSONAL
}

enum AttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
  INVALIDATED
}

enum ProctorEventKind {
  BLUR
  VISIBILITY_HIDDEN
  EXIT_FULLSCREEN
  DEVTOOLS_OPEN
  PASTE
  COPY
  CONTEXTMENU
  TAB_SWITCH
  RESIZE
  NETWORK_OFFLINE
  NETWORK_ONLINE
  MULTI_MONITOR_HINT
}

enum ScoreReleaseMode {
  NONE               // Don't release any scores or feedback
  SCORE_ONLY         // Release score only
  SCORE_WITH_WRONG   // Release score + list of questions they got wrong
  FULL_TEST          // Release score + full test (MCQ + FRQ answers, correctness, feedback)
}

enum TestAuditAction {
  CREATE
  UPDATE
  DELETE
  PUBLISH
  CLOSE
  RESET_PASSWORD
  MANUAL_GRADE
  INVALIDATE_ATTEMPT
}

enum LogType {
  USER_ACTION
  ADMIN_ACTION
  SYSTEM_EVENT
  API_USAGE
  ERROR
  WARNING
}

enum SeverityLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}
